<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">
  <title>How many ping pong balls in?..</title>
  <!-- Bootstrap -->
  <link href="css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link href="css/jumbotron-narrow.css" rel="stylesheet">

  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>
<body>
<a href="https://github.com/haiduc32/howmanyballs"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"></a>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&appId=1410208372606266&version=v2.0";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

  <div class="container">

    <div class="jumbotron">
      <h3>How many ping pong balls can fit in?..</h3>
      <p class="lead">Have you lost sleepless nights wondering how many ping pong balls can fit in your room? 
      Fear no more! This website will help you get the exact number!<p>
    </div>

    <form id="inputForm" class="form-horizontal" data-bind="submit: calculate">
      <div class="form-group">
        <label for="inputUnit" class="col-sm-4 control-label">Unit</label>
        <div class="col-sm-4">
          <select class="form-control" id="inputUnit" data-bind="value: unit">
            <option value="meter"> meter </option>
            <option value="cm"   > cm </option>
            <option value="yard" > yard </option>
            <option value="foot" > foot </option>
            <option value="inch" > inch </option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label for="inputWidth" class="col-sm-4 control-label">Width</label>
        <div class="col-sm-4">
          <input name="inputWidth" type="width" class="form-control" id="inputWidth" placeholder="Width" data-bind="value: width">
        </div>
      </div>
      <div class="form-group">
        <label for="inputLength" class="col-sm-4 control-label">Length</label>
        <div class="col-sm-4">
          <input name="inputLength" type="length" class="form-control" id="inputLength" placeholder="Length" data-bind="value: length">
        </div>
      </div>
      <div class="form-group">
        <label for="inputHeight" class="col-sm-4 control-label">Height</label>
        <div class="col-sm-4">
          <input name="inputHeight" type="height" class="form-control" id="inputHeight" placeholder="Height" data-bind="value: height">
        </div>
      </div>
      <div class="form-group">
        <label for="inputBalls" class="col-sm-4 control-label">Balls</label>
        <div class="col-sm-4">
          <select class="form-control" id="inputBalls" data-bind="value: balls">
            <option value="pong"> Ping Pong (pre 2000)</option>
            <option value="pong2000"> Ping Pong (post 2000)</option>
            <option value="basketball"> Basketball</option>
            <option value="baseball"> Baseball</option>
          </select>
        </div>
      </div>
      <div class="col-md-12 text-center"> 
        <button id="calculateBtn" name="calculateBtn" class="btn btn-primary" type="submit">Calculate!</button> 
      </div>
    </form>
    <div class="row" style="min-height:49px;">
      <div class="col-md-12"> 
        <p class="lead text-center" data-bind="text: calculatedOutput"></p>
      </div>
    </div>

    <div class="row">
      <div class="col-md-12">
        <p class="text-center">If you have just the volume, that's fine, input it down here:</p>
      </div>
    </div>
    <form id="volumeInputForm" class="form-horizontal" data-bind="submit: calculateByVolume">
      <div class="form-group">
        <label for="inputCubicUnit" class="col-sm-4 control-label">Cubic unit</label>
        <div class="col-sm-4">
          <select class="form-control" id="inputCubicUnit" data-bind="value: cubicUnit">
            <option value="meter"> meter </option>
            <option value="cm"   > cm </option>
            <option value="yard" > yard </option>
            <option value="foot" > foot </option>
            <option value="inch" > inch </option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label for="inputVolume" class="col-sm-4 control-label">Volume</label>
        <div class="col-sm-4">
          <input name="inputVolume" type="width" class="form-control" id="inputVolume" placeholder="Volume" data-bind="value: volume">
        </div>
      </div>
      <div class="col-md-12 text-center"> 
        <button id="calculateBtn" name="calculateBtn" class="btn btn-primary" type="submit">Calculate!</button> 
      </div>
    </form>
    <div class="row" style="min-height:49px;">
      <div class="col-md-12"> 
        <p class="lead text-center" data-bind="text: calculatedOutput2"></p>
      </div>
    </div>

    <div class="col-md-12 text-center">
      <!-- social noise starts here -->
      <iframe src="https://ghbtns.com/github-btn.html?user=haiduc32&repo=howmanyballs&type=star&count=true" frameborder="0" scrolling="0" width="90px" height="20px"></iframe>
      
      <a href="https://twitter.com/share" class="twitter-share-button" data-via="haiduc32">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
      
      <div class="fb-share-button" data-href="http://www.radupascal.com/howmanyballs/" data-layout="button_count"></div>
    </div>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'howmanyballs'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    

  </div>

  <footer class="footer">
    <div class="container">
        <p class="text-muted">Â© 2015 - pet project by <a href="http://www.radupascal.com">Radu Pascal</a></p>
    </div>
  </footer>

  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="js/bootstrap.min.js"></script>
  <script src="js/knockout-3.2.0.js"></script>
  <script src="js/jquery.validate.min.js"></script>

  <script>
    $('form:first *:input[type!=hidden]:first').focus();

    // override jquery validate plugin defaults
    $.validator.setDefaults({
        highlight: function (element) {
            $(element).closest('.form-group').addClass('has-error');
        },
        unhighlight: function (element) {
            $(element).closest('.form-group').removeClass('has-error');
        },
        errorElement: 'span',
        errorClass: 'help-block',
        errorPlacement: function (error, element) {
            if (element.parent('.input-group').length) {
                error.insertAfter(element.parent());
            } else {
                error.insertAfter(element);
            }
        }
    });

    $("#inputForm").validate({
      rules: {
        inputWidth: {required: true, number: true, min: 0},
        inputLength: {required: true, number: true, min: 0},
        inputHeight: {required: true, number: true, min: 0}
      }
    });

    $("#volumeInputForm").validate({
      rules: {
        inputVolume: { required: true, number: true, min: 0}
      }
    })
    
    var viewModel = {
      unit: ko.observable(),
      width: ko.observable(),
      length: ko.observable(),
      height: ko.observable(),
      balls: ko.observable(),
      volume: ko.observable(),
      cubicUnit: ko.observable(),
      calculatedOutput: ko.observable(" "),
      calculatedOutput2: ko.observable(" "),
      calculate: function(formElement) {
          //if form input is invalid then exit
          if (!$("#inputForm").valid()) return;

          var boxWidth = transformUnitToCM(viewModel.width(), viewModel.unit());
          var boxLength = transformUnitToCM(viewModel.length(), viewModel.unit());
          var boxHeight = transformUnitToCM(viewModel.height(), viewModel.unit());

          var ball = getBall(viewModel.balls());

          var ballCount1 = calculateHexDistr(boxWidth, boxLength, boxHeight, ball);
          var ballCount2 = calculateHexDistr(boxLength, boxWidth, boxHeight, ball);

          var ballCount3 = calculateCubic(boxWidth, boxLength, boxHeight, ball);
          var ballCount4 = calculateCubic(boxLength, boxWidth, boxHeight, ball);

          var ballCount = Math.max(ballCount1, ballCount2, ballCount3, ballCount4);

          var weight = ballCount * ball.weight;
          var weightText = beautifyWeight(weight, viewModel.unit());
          var text = "You can fit " + ballCount + " balls into that space, with a total weight of " + weightText + ".";
          viewModel.calculatedOutput(text);
        },
      calculateByVolume: function(formElement) {
        //if form input is invalid then exit
          if (!$("#volumeInputForm").valid()) return;

          var cmVolume = transformUnitToCubicCM(viewModel.volume(), viewModel.unit());

          //asume the given volume represents a cube
          //calculate the square root of 3
          var eachSide = Math.pow(cmVolume, 1/3);

          var ball = getBall(viewModel.balls());

          var ballCount1 = calculateHexDistr(eachSide, eachSide, eachSide, ball);
          var ballCount2 = calculateCubic(eachSide, eachSide, eachSide, ball);

          var ballCount = Math.max(ballCount1, ballCount2);

          var weight = ballCount * ball.weight;
          var weightText = beautifyWeight(weight, viewModel.unit());
          var text = "You can fit at most " + ballCount + " balls into that volume, with a total weight of " + weightText + ".";
          viewModel.calculatedOutput2(text);
      }
    }

    //activate knockout js
    ko.applyBindings(viewModel);

    //TODO: implement multiple algorythms:
    //cubic
    //hexagonal distributed
    //hexagonal tight

    function calculateCubic(boxWidth, boxLength, boxHeight, ball) {
      //calculate the number of balls in the row
      var ballsInRowCount = parseInt(boxWidth / ball.diameter);
      var columnsCount = parseInt(boxLength / ball.diameter);
      var layersCount = parseInt(boxHeight / ball.diameter);

      var ballCount = ballsInRowCount * columnsCount * layersCount;
      if (isNaN(ballCount)) ballCount = 0;
      return ballCount;
    }

    function calculateHexDistr(boxWidth, boxLength, boxHeight, ball) {
      if (boxWidth < ball.diameter || boxLength < ball.diameter || boxHeight < ball.diameter) return 0;

      //TODO: lots of validation!

      //calculate the number of balls in the very first row
      var firstRowCount = parseInt(boxWidth / ball.diameter);
      //calculate the remaining distributed space between balls in the row
      var spaceBBallsR = (boxWidth - firstRowCount * ball.diameter) / (firstRowCount - 1);
      //ignore too small values
      if (spaceBBallsR < 0.0001) spaceBBallsR = 0;
      
      var standardRowDist = ball.diameter / 2 * Math.sqrt(3);
      //calculate maximum number of rows
      var rowsCount = parseInt((boxLength - ball.diameter) / standardRowDist + 1);
      //calculate the remaining distributed space between rows
      var spaceBBallsC = boxLength - ball.diameter - (rowsCount - 1) * standardRowDist;
      //ignore too small values
      if (spaceBBallsC < 0.0001) spaceBBallsC = 0;

      //calculate the vertical distance between ball centers from 2 adiacent rows
      var rowCenterDist = Math.sqrt(Math.pow(standardRowDist + spaceBBallsC, 2) + Math.pow((ball.diameter + spaceBBallsR) / 2, 2));
      //calculate the distance from ball centers in layer one to layer two
      //first calculate the circumcenter in the first layer
      var circ = calculateCircumcenter(ball.diameter + spaceBBallsR, rowCenterDist, rowCenterDist);
      //now calculate the distance from ball centers on the vertical axys
      var vertDist = Math.sqrt(Math.pow(ball.diameter, 2) - Math.pow(circ/2, 2));
      
      //calculate the number of layers
      var layerCount = parseInt((boxHeight - ball.diameter)/vertDist) + 1;

      //now we just have to figure out the number of balls..
      var ballsInFirstLayer = firstRowCount * rowsCount - (parseInt(rowsCount / 2));
      var ballsInOddLayers = (firstRowCount - 1) * rowsCount + (parseInt((rowsCount - 1) / 2));
      
      var oddLayers =parseInt(layerCount / 2);
      var fullLayers = layerCount - oddLayers;

      var ballCount = fullLayers * ballsInFirstLayer + oddLayers * ballsInOddLayers;
      if (isNaN(ballCount)) ballCount = 0;
      return ballCount;

    }

    function calculateCircumcenter(a,b,c) {
      var diam = 2 * a * b * c / Math.sqrt((a+b+c) * (-a+b+c) * (a-b+c) * (a+b-c));
      return diam;
    }

    //transform into cm
    function transformUnitToCM(size, unit) {
      switch (unit) {
        case 'meter': return size * 100;
        case 'yard': return size * 91.44;
        case 'foot': return size * 30.48
        case 'inch': return size * 2.54;
      }
      //default is cm
      return size;
    }

    function transformUnitToCubicCM(size, unit) {
      return size * Math.pow(transformUnitToCM(1, unit), 3);
    }

    function getBall(type) {
      switch (type) {
        case 'pong': return { diameter: 3.8, weight: 2.7 };
        case 'pong2000': return { diameter: 4, weight: 2.7 };
        case 'basketball': return {diameter: 35.4, weight: 623.69 };
        case 'baseball': return { diameter: 7.45, weight: 145.5};
      }
    }

    function getIsMetric(unit) {
      switch (unit) {
        case 'meter': return true;
        case 'cm': return true;
        case 'yard': return false;
        case 'foot': return false;
        case 'inch': return false;
      }
    }

    //weight in grams
    function beautifyWeight(weight, isMetric) {
      //TODO: I don't know how to convert for other systems without introducing confusion..
      //if (isMetric) {
        //tons
        if (weight > 1000000) {
          weight = parseInt(weight / 10000);
          return (weight / 100) + " t"
        } else if (weight > 1000) {
          weight = parseInt(weight / 10);
          return (weight / 100) + " kg"
        } else if (weight > 100) {
          return parseInt(weight) + " gr";
        } else {
          return weight + " gr";
        }
      /*} else {
        //calculate the weight in drachms
        var dr = parseInt(weight / 1.7718451953125);
      }*/
    }
  </script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-59470656-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
